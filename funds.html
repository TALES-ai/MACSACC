<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Funds Management - MACS Primary School</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@heroicons/react@2.0.13/24/outline" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #F9FAFB;
      color: #111827;
      display: flex;
      min-height: 100vh;
    }
    .container {
      display: flex;
      flex: 1;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: linear-gradient(to bottom, #1E3A8A, #3B82F6);
      color: #FFFFFF;
      padding: 1.5rem;
      box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
      position: fixed;
      height: 100%;
      overflow-y: auto;
    }
    .sidebar .profile {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .sidebar .profile img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid #22C55E;
      margin-bottom: 0.75rem;
    }
    .sidebar h2 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .sidebar a, .sidebar button {
      display: flex;
      align-items: center;
      color: #FFFFFF;
      padding: 0.75rem 1rem;
      text-decoration: none;
      background: none;
      margin-bottom: 0.5rem;
      border-radius: 0.5rem;
      font-size: 0.9375rem;
      font-weight: 500;
      transition: background 0.2s ease, transform 0.1s;
    }
    .sidebar a:hover, .sidebar button:hover {
      background: #22C55E;
      transform: translateX(4px);
    }
    .sidebar a svg, .sidebar button svg {
      width: 20px;
      height: 20px;
      margin-right: 0.625rem;
    }
    .main-content {
      margin-left: 250px;
      padding: 2rem;
      background: #FFFFFF;
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .section {
      background: rgba(255, 255, 255, 0.9);
      padding: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(8px);
      max-width: 80rem;
      width: 100%;
      margin-bottom: 1.5rem;
    }
    .greeting {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1E3A8A;
      margin-bottom: 0.5rem;
      text-align: center;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    .quote {
      font-size: 1rem;
      color: #374151;
      margin-bottom: 1rem;
      text-align: center;
      font-style: italic;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #E5E7EB;
      text-align: center;
      backdrop-filter: blur(4px);
      transition: transform 0.2s;
    }
    .stat-card:hover {
      transform: scale(1.02);
    }
    .stat-card h3 {
      font-size: 1rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    .stat-card p {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1E3A8A;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      max-width: 80rem;
      width: 100%;
    }
    .filters select, .filters input {
      padding: 0.5rem;
      border: 1px solid #D1D5DB;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      background: #F9FAFB;
      flex: 1;
      min-width: 150px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .filters select:focus, .filters input:focus {
      border-color: #1E3A8A;
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
      outline: none;
    }
    button {
      padding: 0.75rem 1.25rem;
      background: #F59E0B;
      color: #FFFFFF;
      border: none;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    button:hover {
      background: #D97706;
      transform: scale(1.05);
    }
    .error-message {
      color: #EF4444;
      font-size: 0.875rem;
      margin: 1rem 0;
      text-align: center;
      font-weight: 500;
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease;
    }
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .loader-circle {
      width: 48px;
      height: 48px;
      border: 4px solid #E5E7EB;
      border-top: 4px solid #1E3A8A;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .success-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      z-index: 2000;
      text-align: center;
      align-items: center;
      flex-direction: column;
      gap: 1rem;
      animation: slideIn 0.5s ease-in-out;
    }
    .success-modal svg {
      width: 48px;
      height: 48px;
      color: #22C55E;
    }
    .details-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(8px);
      z-index: 2000;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.5s ease-in-out;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1.25rem;
      table-layout: fixed;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #E5E7EB;
      font-size: 0.875rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background: #1E3A8A;
      color: #FFFFFF;
      font-weight: 600;
      cursor: pointer;
      position: relative;
    }
    th:hover {
      background: #3B82F6;
    }
    th.sort-asc::after {
      content: "↑";
      position: absolute;
      right: 8px;
    }
    th.sort-desc::after {
      content: "↓";
      position: absolute;
      right: 8px;
    }
    tr {
      transition: background 0.2s, transform 0.2s;
      animation: fadeIn 0.5s ease-in;
    }
    tr:hover {
      background: #E5E7EB;
      transform: scale(1.01);
    }
    tr:nth-child(even) {
      background: #F9FAFB;
    }
    th:nth-child(1), td:nth-child(1) { width: 12%; } /* Date */
    th:nth-child(2), td:nth-child(2) { width: 14%; } /* Means of Payment */
    th:nth-child(3), td:nth-child(3) { width: 12%; } /* Amount */
    th:nth-child(4), td:nth-child(4) { width: 10%; } /* Type */
    th:nth-child(5), td:nth-child(5) { width: 30%; } /* Description */
    th:nth-child(6), td:nth-child(6) { width: 12%; } /* Posted By */
    th:nth-child(7), td:nth-child(7) { width: 10%; } /* Transaction Code */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1.5rem;
    }
    .pagination button {
      padding: 0.5rem 1rem;
      background: #F9FAFB;
      color: #1E3A8A;
      border: 1px solid #D1D5DB;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
    }
    .pagination button:hover {
      background: #1E3A8A;
      color: #FFFFFF;
      transform: scale(1.05);
    }
    .pagination button:disabled {
      background: #E5E7EB;
      color: #6B7280;
      cursor: not-allowed;
      transform: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes slideIn {
      from { transform: translate(-50%, -60%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="loader-circle"></div>
  </div>
  <div class="success-modal" id="exportModal">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>
    <p id="exportText" class="text-lg font-medium text-gray-900"></p>
  </div>
  <div class="details-modal" id="detailsModal">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Transaction Details</h3>
    <p><strong>Date:</strong> <span id="detailDate"></span></p>
    <p><strong>Means of Payment:</strong> <span id="detailMethod"></span></p>
    <p><strong>Amount:</strong> <span id="detailAmount"></span></p>
    <p><strong>Type:</strong> <span id="detailType"></span></p>
    <p><strong>Description:</strong> <span id="detailDescription"></span></p>
    <p><strong>Posted By:</strong> <span id="detailPostedBy"></span></p>
    <p><strong>Transaction Code:</strong> <span id="detailTransactionCode"></span></p>
    <p><strong>Balance After:</strong> <span id="detailBalanceAfter"></span></p>
    <p><strong>Student Reg No:</strong> <span id="detailRegNo"></span></p>
    <p><strong>Student Name:</strong> <span id="detailStudentName"></span></p>
    <button onclick="document.getElementById('detailsModal').style.display='none'">Close</button>
  </div>
  <div class="container">
    <div class="sidebar">
      <div class="profile">
        <img src="https://img.icons8.com/color/80/000000/accountant.png" alt="Accountant Icon">
        <p id="accountantName"></p>
      </div>
      <h2>Accountant Portal</h2>
      <a href="accountant.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        Dashboard
      </a>
      <a href="students.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
        </svg>
        Students
      </a>
      <a href="uploadFees.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Upload Fees
      </a>
      <a href="feeRecords.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Fee Records
      </a>
      <a href="announcements.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        Announcements
      </a>
      <a href="funds.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a2 2 0 012-2h2a2 2 0 012 2v5m-4 0h4" />
        </svg>
        Funds Management
      </a>
      <a href="otherFunds.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        Other Funds
      </a>
      <a href="requests.html">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01m-.01 4h.01" />
        </svg>
        Requests
      </a>
      <button onclick="logout()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h3a3 3 0 013 3v1" />
        </svg>
        Logout
      </button>
    </div>
    <div class="main-content">
      <div class="section">
        <h1 class="greeting" id="greeting"></h1>
        <p class="quote" id="quote"></p>
      </div>
      <div class="section stats-grid">
        <div class="stat-card">
          <h3>Total Funds</h3>
          <p id="totalFunds">0 KES</p>
        </div>
        <div class="stat-card">
          <h3>Incoming Today</h3>
          <p id="incomingToday">0 KES</p>
        </div>
        <div class="stat-card">
          <h3>Outgoing Today</h3>
          <p id="outgoingToday">0 KES</p>
        </div>
      </div>
      <div class="section">
        <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6 mr-2 text-f59e0b">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          Funds Management
        </h2>
        <div class="filters">
          <input id="searchBar" type="text" placeholder="Search by Description, Transaction Code..." oninput="filterTransactions()">
          <select id="methodFilter" onchange="filterTransactions()">
            <option value="">All Methods</option>
            <option value="bank">Bank</option>
            <option value="mpesa">M-Pesa</option>
            <option value="cash">Cash</option>
            <option value="bursary">Bursary</option>
          </select>
          <select id="typeFilter" onchange="filterTransactions()">
            <option value="">All Types</option>
            <option value="Incoming">Incoming</option>
            <option value="Outgoing">Outgoing</option>
          </select>
          <input id="dateStart" type="date" onchange="filterTransactions()">
          <input id="dateEnd" type="date" onchange="filterTransactions()">
        </div>
        <div class="flex space-x-4 mb-6">
          <button onclick="downloadCSV()">Download CSV</button>
          <button onclick="downloadJSON()">Download JSON</button>
          <button onclick="downloadPDF()">Download PDF</button>
        </div>
        <table id="fundsTable">
          <thead>
            <tr>
              <th onclick="sortTable('date')">Date</th>
              <th onclick="sortTable('method')">Means of Payment</th>
              <th onclick="sortTable('amount')">Amount (KES)</th>
              <th onclick="sortTable('type')">Type</th>
              <th onclick="sortTable('description')">Description</th>
              <th onclick="sortTable('postedBy')">Posted By</th>
              <th onclick="sortTable('transactionCode')">Transaction Code</th>
            </tr>
          </thead>
          <tbody id="fundsBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
        <div id="fundsMessage" class="error-message"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqVIFxRrkNSejRuNY9NPYrMpUShO2Yz7U",
      authDomain: "lifeflow-yhtl6.firebaseapp.com",
      databaseURL: "https://lifeflow-yhtl6-default-rtdb.firebaseio.com",
      projectId: "lifeflow-yhtl6",
      storageBucket: "lifeflow-yhtl6.firebasestorage.app",
      messagingSenderId: "129785956666",
      appId: "1:129785956666:web:541a08bee37c739556a803"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const loadingScreen = document.getElementById("loadingScreen");
    const exportModal = document.getElementById("exportModal");
    let allTransactions = [];
    let currentPage = 1;
    const transactionsPerPage = 10;
    let sortColumn = 'timestamp';
    let sortDirection = 'desc';

    auth.onAuthStateChanged(async user => {
      if (!user) {
        console.error("Authentication failed: No user logged in");
        sessionStorage.clear();
        window.location.href = "index.html";
        return;
      }

      try {
        const userEmail = user.email;
        const allowedEmails = ["macsschool@account.ac", "stellamachogu2025@gmail.com", "bttc@admin.ep.finley"];
        console.log("Checking user permissions:", { userId: user.uid, userEmail });

        const userSnapshot = await db.ref(`users/${user.uid}/role`).once("value");
        const userRole = userSnapshot.val();
        console.log(`User role from Firebase: ${userRole || 'none'}`);

        if (!allowedEmails.includes(userEmail) && userRole !== "admin" && userRole !== "accountant") {
          console.error("Permission denied: User lacks required role or email", { userId: user.uid, userEmail, userRole });
          sessionStorage.clear();
          window.location.href = "index.html";
          return;
        }

        const accountantEmail = sessionStorage.getItem("username") || userEmail || "macsschool@account.ac";
        const accountantName = accountantEmail.split("@")[0].replace(/\d/g, "");
        document.getElementById("accountantName").textContent = accountantName;

        // Greeting and quote (07:43 PM EAT)
        const hour = new Date().getHours();
        const greeting = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
        document.getElementById("greeting").textContent = `${greeting}, ${accountantName}`;
        const quotes = [
          "Manage funds with precision and ease!",
          "Your financial hub for excellence.",
          "Track every shilling, every moment.",
          "Empowering MACS with seamless accounting."
        ];
        const day = new Date().getDay();
        document.getElementById("quote").textContent = quotes[day % quotes.length];

        loadTransactions();
        loadStats();
        setTimeout(() => loadingScreen.classList.add("hidden"), 300);
      } catch (error) {
        console.error("Error checking user role:", error);
        showMessage("fundsMessage", `Authentication error: ${error.message}`);
        sessionStorage.clear();
        window.location.href = "index.html";
      }
    });

    function showMessage(elementId, message, isError = true) {
      const messageDiv = document.getElementById(elementId);
      messageDiv.textContent = message;
      messageDiv.style.color = isError ? "#EF4444" : "#22C55E";
      messageDiv.style.display = "block";
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 3000);
    }

    function showExportMessage(format) {
      document.getElementById("exportText").textContent = `Exported as ${format} successfully!`;
      exportModal.style.display = "flex";
      setTimeout(() => {
        exportModal.style.display = "none";
      }, 2000);
    }

    function logout() {
      auth.signOut().then(() => {
        sessionStorage.clear();
        window.location.href = "index.html";
      }).catch(error => {
        console.error("Logout error:", error);
        showMessage("fundsMessage", `Logout failed: ${error.message}`);
      });
    }

    async function loadTransactions() {
      const tableBody = document.getElementById("fundsBody");
      tableBody.innerHTML = "";
      allTransactions = [];

      try {
        console.log("Fetching transactions from 'transactions' node");
        const snapshot = await db.ref("transactions").once("value");
        const transactions = snapshot.val() || {};
        const studentSnapshot = await db.ref("users/students").once("value");
        const students = studentSnapshot.val() || {};

        for (const [key, tx] of Object.entries(transactions)) {
          if (tx && tx.amount != null && tx.description && tx.status === "completed" && tx.timestamp && tx.type) {
            let method = tx.method || "N/A";
            if (tx.type === "fee_payment" && tx.regNo) {
              const studentTx = students[tx.regNo]?.fees?.transactions || {};
              const matchingTx = Object.values(studentTx).find(stx => stx.transactionCode === tx.transactionCode);
              method = matchingTx?.method ? matchingTx.method.charAt(0).toUpperCase() + matchingTx.method.slice(1) : "N/A";
            }
            const type = ["fee_payment", "other_funds_uniform", "addition"].includes(tx.type) ? "Incoming" : tx.type === "deduction" ? "Outgoing" : tx.type;
            allTransactions.push({
              key,
              date: new Date(tx.timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
              method,
              amount: Number(tx.amount),
              type,
              description: tx.description,
              postedBy: tx.accountant || (tx.description.match(/by\s+([^\s]+)/i)?.[1] || "macsschool"),
              transactionCode: tx.transactionCode || "N/A",
              timestamp: tx.timestamp,
              balanceAfter: tx.balance_after || "N/A",
              regNo: tx.regNo || "N/A",
              studentName: tx.studentName || "N/A"
            });
          } else {
            console.warn(`Skipping invalid transaction for key: ${key}`, tx);
          }
        }

        console.log(`Loaded ${allTransactions.length} valid transactions`);

        // Real-time listener for new transactions
        db.ref("transactions").orderByChild("timestamp").on("child_added", (snapshot) => {
          const tx = snapshot.val();
          if (tx && tx.amount != null && tx.description && tx.status === "completed" && tx.timestamp && tx.type) {
            let method = tx.method || "N/A";
            if (tx.type === "fee_payment" && tx.regNo) {
              db.ref(`users/students/${tx.regNo}/fees/transactions`).orderByChild("transactionCode").equalTo(tx.transactionCode).once("value", (studentSnap) => {
                const studentTx = Object.values(studentSnap.val() || {}).find(stx => stx.transactionCode === tx.transactionCode);
                method = studentTx?.method ? studentTx.method.charAt(0).toUpperCase() + studentTx.method.slice(1) : "N/A";
                allTransactions.unshift({
                  key: snapshot.key,
                  date: new Date(tx.timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
                  method,
                  amount: Number(tx.amount),
                  type: ["fee_payment", "other_funds_uniform", "addition"].includes(tx.type) ? "Incoming" : tx.type === "deduction" ? "Outgoing" : tx.type,
                  description: tx.description,
                  postedBy: tx.accountant || (tx.description.match(/by\s+([^\s]+)/i)?.[1] || "macsschool"),
                  transactionCode: tx.transactionCode || "N/A",
                  timestamp: tx.timestamp,
                  balanceAfter: tx.balance_after || "N/A",
                  regNo: tx.regNo || "N/A",
                  studentName: tx.studentName || "N/A"
                });
                filterTransactions();
              });
            } else {
              allTransactions.unshift({
                key: snapshot.key,
                date: new Date(tx.timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }),
                method,
                amount: Number(tx.amount),
                type: ["fee_payment", "other_funds_uniform", "addition"].includes(tx.type) ? "Incoming" : tx.type === "deduction" ? "Outgoing" : tx.type,
                description: tx.description,
                postedBy: tx.accountant || (tx.description.match(/by\s+([^\s]+)/i)?.[1] || "macsschool"),
                transactionCode: tx.transactionCode || "N/A",
                timestamp: tx.timestamp,
                balanceAfter: tx.balance_after || "N/A",
                regNo: tx.regNo || "N/A",
                studentName: tx.studentName || "N/A"
              });
              filterTransactions();
            }
          }
        });

        filterTransactions();
      } catch (error) {
        console.error("Error loading transactions:", error);
        showMessage("fundsMessage", `Failed to load transactions: ${error.message}`);
        tableBody.innerHTML = `<tr><td colspan="7">Failed to load transactions: ${error.message}</td></tr>`;
      }
    }

    async function loadStats() {
      try {
        const today = new Date().toLocaleDateString("en-US", { timeZone: "Africa/Nairobi" });
        let totalFunds = 0;
        let incomingToday = 0;
        let outgoingToday = 0;

        const snapshot = await db.ref("school_funds/balance").once("value");
        totalFunds = snapshot.val() || 0;

        const transactions = allTransactions.filter(tx => tx.date === new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }));
        transactions.forEach(tx => {
          if (tx.type === "Incoming") {
            incomingToday += tx.amount;
          } else if (tx.type === "Outgoing") {
            outgoingToday += tx.amount;
          }
        });

        document.getElementById("totalFunds").textContent = `${totalFunds.toFixed(2)} KES`;
        document.getElementById("incomingToday").textContent = `${incomingToday.toFixed(2)} KES`;
        document.getElementById("outgoingToday").textContent = `${outgoingToday.toFixed(2)} KES`;
      } catch (error) {
        console.error("Error loading stats:", error);
        showMessage("fundsMessage", `Failed to load stats: ${error.message}`);
      }
    }

    function sortTable(column) {
      if (sortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }

      const headers = document.querySelectorAll("th");
      headers.forEach(header => {
        header.classList.remove("sort-asc", "sort-desc");
        if (header.textContent.toLowerCase() === column.replace(/([A-Z])/g, ' $1').toLowerCase()) {
          header.classList.add(`sort-${sortDirection}`);
        }
      });

      allTransactions.sort((a, b) => {
        let valA = a[column] || '';
        let valB = b[column] || '';
        if (column === 'amount') {
          valA = Number(valA);
          valB = Number(valB);
        } else if (column === 'date') {
          valA = new Date(a.timestamp);
          valB = new Date(b.timestamp);
        } else {
          valA = valA.toString().toLowerCase();
          valB = valB.toString().toLowerCase();
        }
        return sortDirection === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
      });

      filterTransactions();
    }

    function filterTransactions() {
      const searchTerm = document.getElementById("searchBar").value.toLowerCase();
      const methodFilter = document.getElementById("methodFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const dateStart = document.getElementById("dateStart").value;
      const dateEnd = document.getElementById("dateEnd").value;
      const tableBody = document.getElementById("fundsBody");
      tableBody.innerHTML = "";

      let filteredTransactions = allTransactions.filter(tx => {
        const matchesSearch = (
          (tx.description || "").toLowerCase().includes(searchTerm) ||
          (tx.transactionCode || "").toLowerCase().includes(searchTerm) ||
          (tx.postedBy || "").toLowerCase().includes(searchTerm)
        );
        const matchesMethod = !methodFilter || tx.method === methodFilter;
        const matchesType = !typeFilter || tx.type === typeFilter;
        const txDate = new Date(tx.timestamp);
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const matchesDate = (!startDate || txDate >= startDate) && (!endDate || txDate <= new Date(endDate.setHours(23, 59, 59, 999)));
        return matchesSearch && matchesMethod && matchesType && matchesDate;
      });

      const totalPages = Math.ceil(filteredTransactions.length / transactionsPerPage);
      filteredTransactions = filteredTransactions.slice((currentPage - 1) * transactionsPerPage, currentPage * transactionsPerPage);

      if (filteredTransactions.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="7">No transactions match the criteria.</td></tr>`;
        updatePagination(totalPages);
        return;
      }

      filteredTransactions.forEach(tx => {
        const row = document.createElement("tr");
        row.style.cursor = "pointer";
        row.onclick = () => showDetails(tx);
        row.innerHTML = `
          <td>${tx.date}</td>
          <td>${tx.method}</td>
          <td>${tx.amount.toFixed(2)}</td>
          <td>${tx.type}</td>
          <td>${tx.description}</td>
          <td>${tx.postedBy}</td>
          <td>${tx.transactionCode}</td>
        `;
        tableBody.appendChild(row);
      });

      updatePagination(totalPages);
    }

    function showDetails(tx) {
      document.getElementById("detailDate").textContent = tx.date;
      document.getElementById("detailMethod").textContent = tx.method;
      document.getElementById("detailAmount").textContent = `${tx.amount.toFixed(2)} KES`;
      document.getElementById("detailType").textContent = tx.type;
      document.getElementById("detailDescription").textContent = tx.description;
      document.getElementById("detailPostedBy").textContent = tx.postedBy;
      document.getElementById("detailTransactionCode").textContent = tx.transactionCode;
      document.getElementById("detailBalanceAfter").textContent = `${tx.balanceAfter} KES`;
      document.getElementById("detailRegNo").textContent = tx.regNo;
      document.getElementById("detailStudentName").textContent = tx.studentName;
      document.getElementById("detailsModal").style.display = "block";
    }

    function updatePagination(totalPages) {
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = "";
      if (totalPages <= 1) return;

      const prevButton = document.createElement("button");
      prevButton.textContent = "Previous";
      prevButton.disabled = currentPage === 1;
      prevButton.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          filterTransactions();
        }
      };
      pagination.appendChild(prevButton);

      for (let i = 1; i <= totalPages; i++) {
        const button = document.createElement("button");
        button.textContent = i;
        button.disabled = i === currentPage;
        button.onclick = () => {
          currentPage = i;
          filterTransactions();
        };
        pagination.appendChild(button);
      }

      const nextButton = document.createElement("button");
      nextButton.textContent = "Next";
      nextButton.disabled = currentPage === totalPages;
      nextButton.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          filterTransactions();
        }
      };
      pagination.appendChild(nextButton);
    }

    function downloadCSV() {
      const searchTerm = document.getElementById("searchBar").value.toLowerCase();
      const methodFilter = document.getElementById("methodFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const dateStart = document.getElementById("dateStart").value;
      const dateEnd = document.getElementById("dateEnd").value;
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      const fileName = `Funds_Transactions_${date}.csv`;

      const filteredTransactions = allTransactions.filter(tx => {
        const matchesSearch = (
          (tx.description || "").toLowerCase().includes(searchTerm) ||
          (tx.transactionCode || "").toLowerCase().includes(searchTerm) ||
          (tx.postedBy || "").toLowerCase().includes(searchTerm)
        );
        const matchesMethod = !methodFilter || tx.method === methodFilter;
        const matchesType = !typeFilter || tx.type === typeFilter;
        const txDate = new Date(tx.timestamp);
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const matchesDate = (!startDate || txDate >= startDate) && (!endDate || txDate <= new Date(endDate.setHours(23, 59, 59, 999)));
        return matchesSearch && matchesMethod && matchesType && matchesDate;
      });

      const headers = ["Date,Means of Payment,Amount (KES),Type,Description,Posted By,Transaction Code"];
      const rows = filteredTransactions.map(tx => 
        `"${tx.date}","${tx.method}","${tx.amount.toFixed(2)}","${tx.type}","${tx.description.replace(/"/g, '""')}","${tx.postedBy}","${tx.transactionCode}"`
      );

      const csvContent = headers.concat(rows).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
      URL.revokeObjectURL(link.href);
      showExportMessage("CSV");
    }

    function downloadJSON() {
      const searchTerm = document.getElementById("searchBar").value.toLowerCase();
      const methodFilter = document.getElementById("methodFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const dateStart = document.getElementById("dateStart").value;
      const dateEnd = document.getElementById("dateEnd").value;
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      const fileName = `Funds_Transactions_${date}.json`;

      const filteredTransactions = allTransactions.filter(tx => {
        const matchesSearch = (
          (tx.description || "").toLowerCase().includes(searchTerm) ||
          (tx.transactionCode || "").toLowerCase().includes(searchTerm) ||
          (tx.postedBy || "").toLowerCase().includes(searchTerm)
        );
        const matchesMethod = !methodFilter || tx.method === methodFilter;
        const matchesType = !typeFilter || tx.type === typeFilter;
        const txDate = new Date(tx.timestamp);
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const matchesDate = (!startDate || txDate >= startDate) && (!endDate || txDate <= new Date(endDate.setHours(23, 59, 59, 999)));
        return matchesSearch && matchesMethod && matchesType && matchesDate;
      });

      const jsonContent = JSON.stringify(filteredTransactions.map(tx => ({
        Date: tx.date,
        "Means of Payment": tx.method,
        "Amount (KES)": tx.amount.toFixed(2),
        Type: tx.type,
        Description: tx.description,
        "Posted By": tx.postedBy,
        "Transaction Code": tx.transactionCode
      })), null, 2);
      const blob = new Blob([jsonContent], { type: "application/json;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      link.click();
      URL.revokeObjectURL(link.href);
      showExportMessage("JSON");
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const searchTerm = document.getElementById("searchBar").value.toLowerCase();
      const methodFilter = document.getElementById("methodFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const dateStart = document.getElementById("dateStart").value;
      const dateEnd = document.getElementById("dateEnd").value;
      const date = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      const fileName = `Funds_Transactions_${date}.pdf`;

      const filteredTransactions = allTransactions.filter(tx => {
        const matchesSearch = (
          (tx.description || "").toLowerCase().includes(searchTerm) ||
          (tx.transactionCode || "").toLowerCase().includes(searchTerm) ||
          (tx.postedBy || "").toLowerCase().includes(searchTerm)
        );
        const matchesMethod = !methodFilter || tx.method === methodFilter;
        const matchesType = !typeFilter || tx.type === typeFilter;
        const txDate = new Date(tx.timestamp);
        const startDate = dateStart ? new Date(dateStart) : null;
        const endDate = dateEnd ? new Date(dateEnd) : null;
        const matchesDate = (!startDate || txDate >= startDate) && (!endDate || txDate <= new Date(endDate.setHours(23, 59, 59, 999)));
        return matchesSearch && matchesMethod && matchesType && matchesDate;
      });

      doc.setFontSize(16);
      doc.text("MACS Primary School - Funds Transactions", 14, 22);
      doc.setFontSize(10);
      doc.text(`Generated on: ${new Date().toLocaleDateString('en-GB')}`, 14, 30);

      doc.autoTable({
        head: [['Date', 'Means of Payment', 'Amount (KES)', 'Type', 'Description', 'Posted By', 'Transaction Code']],
        body: filteredTransactions.map(tx => [
          tx.date,
          tx.method,
          tx.amount.toFixed(2),
          tx.type,
          tx.description,
          tx.postedBy,
          tx.transactionCode
        ]),
        startY: 40,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [30, 58, 138], textColor: [255, 255, 255] },
        alternateRowStyles: { fillColor: [249, 250, 251] },
        columnStyles: {
          0: { cellWidth: 25 },
          1: { cellWidth: 25 },
          2: { cellWidth: 20 },
          3: { cellWidth: 20 },
          4: { cellWidth: 50 },
          5: { cellWidth: 25 },
          6: { cellWidth: 25 }
        }
      });

      doc.save(fileName);
      showExportMessage("PDF");
    }
  </script>
</body>
</html>= N 