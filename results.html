<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Portal - Results - MACS SCHOOLS EA</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e0e7ff, #a5b4fc);
      color: #1e293b;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 280px;
      background: linear-gradient(to bottom, #4f46e5, #f43f5e);
      color: #fff;
      padding: 30px 20px;
      box-shadow: 5px 0 20px rgba(0, 0, 0, 0.15);
      position: fixed;
      height: 100%;
      overflow-y: auto;
      transition: width 0.3s ease;
    }
    .sidebar:hover {
      width: 300px;
    }
    .sidebar .profile {
      text-align: center;
      margin-bottom: 40px;
    }
    .sidebar .profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: 4px solid #fef08a;
      margin-bottom: 15px;
      transition: transform 0.3s;
    }
    .sidebar .profile img:hover {
      transform: rotate(360deg) scale(1.1);
    }
    .sidebar h2 {
      font-size: 28px;
      margin-bottom: 40px;
      text-align: center;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
      letter-spacing: 1px;
    }
    .sidebar a, .sidebar button {
      display: flex;
      align-items: center;
      color: #fff;
      padding: 15px 20px;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.15);
      margin-bottom: 12px;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .sidebar a i, .sidebar button i {
      margin-right: 12px;
      font-size: 18px;
      transition: transform 0.3s;
    }
    .sidebar a:hover i, .sidebar button:hover i {
      transform: rotate(20deg);
    }
    .sidebar a:hover, .sidebar button:hover, .sidebar a.active {
      background: rgba(255, 255, 255, 0.35);
      transform: translateX(8px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .main-content {
      flex: 1;
      margin-left: 280px;
      padding: 40px;
      background: #f8fafc;
      transition: margin-left 0.3s ease;
    }
    .sidebar:hover ~ .main-content {
      margin-left: 300px;
    }
    .section {
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .section h1 {
      font-size: 32px;
      color: #4f46e5;
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      font-weight: 600;
    }
    .section h1 i {
      margin-right: 12px;
      font-size: 28px;
      color: #f43f5e;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    .form-group label {
      font-weight: 600;
      color: #1e293b;
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .form-group select {
      width: 100%;
      max-width: 400px;
      padding: 12px 12px 12px 40px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 15px;
      background: #fff;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%234f46e5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
    }
    .form-group select:focus {
      border-color: #4f46e5;
      box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
      outline: none;
    }
    .form-group i {
      position: absolute;
      left: 12px;
      top: 38px;
      color: #4f46e5;
      font-size: 18px;
    }
    button {
      padding: 12px 24px;
      background: linear-gradient(to right, #f43f5e, #fb923c);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      font-weight: 500;
      margin-right: 10px;
    }
    button i {
      margin-right: 10px;
      font-size: 16px;
    }
    button:hover {
      background: linear-gradient(to right, #fb923c, #f43f5e);
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .error-message, .success-message {
      max-width: 600px;
      font-size: 15px;
      padding: 10px;
      border-radius: 8px;
      margin: 15px 0;
      opacity: 0;
      animation: fadeInOut 6s forwards;
      display: flex;
      align-items: center;
    }
    .error-message i, .success-message i {
      margin-right: 10px;
      font-size: 18px;
    }
    .error-message {
      color: #dc2626;
      background: #fee2e2;
    }
    .success-message {
      color: #15803d;
      background: #dcfce7;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    .loading-screen.hidden {
      display: none;
    }
    .loading-screen div {
      font-size: 18px;
      color: #4f46e5;
      display: flex;
      align-items: center;
    }
    .loading-screen i {
      margin-right: 10px;
      font-size: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .timestamp {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 20px;
      text-align: right;
      font-style: italic;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 20px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    table th, table td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: center;
    }
    table th {
      background-color: #dbeafe;
      font-weight: 600;
      color: #1e293b;
    }
    table td {
      background-color: #f9fafb;
    }
    table tr:nth-child(even) {
      background-color: #f1f5f9;
    }
    table tr:hover {
      background-color: #e0e7ff;
      transition: background-color 0.2s;
    }
    .results-table-container {
      max-width: 100%;
      overflow-x: auto;
      margin-top: 20px;
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .summary {
      margin-top: 20px;
      font-size: 16px;
      color: #1e293b;
      font-weight: 600;
      text-align: left;
      background: #e0e7ff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
    }
    .summary i {
      margin-right: 10px;
      color: #4f46e5;
      font-size: 20px;
    }
    .top-performers {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease-in;
    }
    .top-performers h3 {
      font-size: 24px;
      color: #4f46e5;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    .top-performers h3 i {
      margin-right: 10px;
      color: #f43f5e;
    }
    .top-performers ul {
      list-style: none;
      padding: 0;
    }
    .top-performers li {
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }
    .top-performers li i {
      margin-right: 10px;
      font-size: 18px;
    }
    .top-performers li:nth-child(1) i {
      color: #ffd700;
    }
    .top-performers li:nth-child(2) i {
      color: #c0c0c0;
    }
    .top-performers li:nth-child(3) i {
      color: #cd7f32;
    }
    .subject-performance {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: fadeIn 0.5s ease-in;
    }
    .subject-performance h3 {
      font-size: 24px;
      color: #4f46e5;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }
    .subject-performance h3 i {
      margin-right: 10px;
      color: #f43f5e;
    }
    .subject-performance table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .subject-performance th, .subject-performance td {
      border: 1px solid #d1d5db;
      padding: 10px;
      text-align: left;
    }
    .subject-performance th {
      background: #dbeafe;
      font-weight: 600;
    }
    .subject-performance tr:nth-child(even) {
      background: #f9f9f9;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 220px;
      }
      .main-content {
        margin-left: 220px;
        padding: 20px;
      }
      .form-group select {
        max-width: 100%;
        font-size: 14px;
      }
      table {
        font-size: 12px;
      }
      table th, table td {
        padding: 6px;
      }
    }
    @media (max-width: 480px) {
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      .main-content {
        margin-left: 0;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div><i class="fas fa-spinner"></i> Processing...</div>
  </div>
  <div class="container">
    <div class="sidebar">
      <div class="profile">
        <img src="https://img.icons8.com/color/100/000000/teacher.png" alt="Teacher Icon">
        <p id="teacherName">Loading...</p>
      </div>
      <h2>Teacher Portal</h2>
      <a href="teacher.html"><i class="fas fa-info-circle"></i> Guide</a>
      <a href="students.html"><i class="fas fa-users"></i> Students</a>
      <a href="add-student.html"><i class="fas fa-user-plus"></i> Add Student</a>
      <a href="marks.html"><i class="fas fa-chart-line"></i> Upload Marks</a>
      <a href="announcements.html"><i class="fas fa-bullhorn"></i> Announcements</a>
      <a href="results.html" class="active"><i class="fas fa-file-alt"></i> Results</a>
      <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
    <div class="main-content">
      <div id="results" class="section">
        <h1><i class="fas fa-file-alt"></i> Class Results</h1>
        <div class="timestamp" id="currentTime"></div>
        <div class="form-group">
          <label for="termSelect">Term</label>
          <i class="fas fa-calendar-alt"></i>
          <select id="termSelect" onchange="loadResults()">
            <option value="">Select Term</option>
            <option value="term1">Term 1</option>
            <option value="term2">Term 2</option>
            <option value="term3">Term 3</option>
          </select>
        </div>
        <div class="form-group">
          <label for="assessmentType">Assessment Type</label>
          <i class="fas fa-list"></i>
          <select id="assessmentType" onchange="loadResults()">
            <option value="">Select Assessment</option>
            <option value="cat">CAT (Mid-Term)</option>
            <option value="exam">End-Term Exam</option>
          </select>
        </div>
        <div class="form-group">
          <label for="classSelect">Class</label>
          <i class="fas fa-school"></i>
          <select id="classSelect" onchange="loadResults()">
            <option value="">Select Class</option>
          </select>
        </div>
        <button onclick="loadResults()"><i class="fas fa-search"></i> Load Results</button>
        <button onclick="generatePDF()" disabled id="pdfButton"><i class="fas fa-file-pdf"></i> Generate PDF</button>
        <button onclick="generateReportCardsPDF()" disabled id="reportCardsButton"><i class="fas fa-file-pdf"></i> Generate Report Cards</button>
        <div id="resultsMessage" class="error-message"></div>
        <div id="topPerformers" class="top-performers" style="display: none;">
          <h3><i class="fas fa-trophy"></i> Top Performers</h3>
          <ul></ul>
        </div>
        <div id="subjectPerformance" class="subject-performance" style="display: none;">
          <h3><i class="fas fa-chart-bar"></i> Subject Performance Summary</h3>
          <table id="subjectPerformanceTable"></table>
        </div>
        <div class="results-table-container" id="resultsTable"></div>
        <div id="summary" class="summary"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDqVIFxRrkNSejRuNY9NPYrMpUShO2Yz7U",
      authDomain: "lifeflow-yhtl6.firebaseapp.com",
      projectId: "lifeflow-yhtl6",
      storageBucket: "lifeflow-yhtl6.firebasestorage.app",
      messagingSenderId: "129785956666",
      appId: "1:129785956666:web:541a08bee37c739556a803",
      databaseURL: "https://lifeflow-yhtl6-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const gradingTable = [
      { range: [90, 99], rubric: "E.E 1", outcome: 8.0 },
      { range: [75, 89], rubric: "E.E 2", outcome: 7.0 },
      { range: [58, 74], rubric: "M.E 1", outcome: 6.0 },
      { range: [41, 57], rubric: "M.E 2", outcome: 5.0 },
      { range: [31, 40], rubric: "A.E 1", outcome: 4.0 },
      { range: [21, 30], rubric: "A.E 2", outcome: 3.0 },
      { range: [11, 20], rubric: "B.E 1", outcome: 2.0 },
      { range: [1, 10], rubric: "B.E 2", outcome: 1.0 },
      { range: [0, 0], rubric: "", outcome: 0 }
    ];

    function getComment(mean) {
      if (mean >= 90) return "Outstanding! Excellent work. Keep shining!";
      else if (mean >= 75) return "Very Good. Well done. Maintain the momentum.";
      else if (mean >= 58) return "Good. You're doing well. Aim higher!";
      else if (mean >= 41) return "Fair. You can improve. Pull up your socks!";
      else if (mean >= 31) return "Needs Improvement. Seek extra help. You can do better!";
      else return "Poor performance. Immediate attention required. Let's work together.";
    }

    function updateTimestamp() {
      const timestampElement = document.getElementById("currentTime");
      const now = new Date();
      timestampElement.textContent = `Last Updated: ${now.toLocaleString('en-US', { 
        timeZone: 'Africa/Nairobi', 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric', 
        hour: 'numeric', 
        minute: 'numeric', 
        hour12: true 
      })}`;
    }

    auth.onAuthStateChanged(user => {
      if (!user || localStorage.getItem("userType") !== "teacher") {
        localStorage.clear();
        window.location.href = "index.html";
      } else {
        const teacherName = localStorage.getItem("teacherName") || user.displayName || user.email.split("@")[0].replace(/[^a-zA-Z0-9\s]/g, "") || "Teacher";
        document.getElementById("teacherName").textContent = teacherName;
        document.getElementById("loadingScreen").classList.add("hidden");
        updateTimestamp();
        setInterval(updateTimestamp, 60000);
        loadClasses();
      }
    });

    function showMessage(elementId, message, isError = true) {
      const messageDiv = document.getElementById(elementId);
      messageDiv.innerHTML = (isError ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>') + message;
      messageDiv.className = isError ? "error-message" : "success-message";
      messageDiv.style.display = "block";
      setTimeout(() => {
        messageDiv.style.display = "none";
      }, 6000);
    }

    function loadClasses() {
      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = "<option value=''>Select Class</option>";
      db.ref("users/students").once("value")
        .then(snapshot => {
          const students = snapshot.val() || {};
          const classes = new Set();
          Object.values(students).forEach(student => {
            if (student.form) {
              classes.add(student.form);
            }
          });
          Array.from(classes).sort((a, b) => {
            const order = ["playgroup", "preprimary1", "preprimary2", "grade1", "grade2", "grade3", "grade4", "grade5", "grade6", "grade7", "grade8", "grade9"];
            return order.indexOf(a) - order.indexOf(b);
          }).forEach(cls => {
            const displayClass = cls.replace(/^(playgroup|preprimary|grade)/, match => ({
              playgroup: "Playgroup",
              preprimary: "Pre-Primary ",
              grade: "Grade "
            }[match])).replace(/(\d)$/, " $1");
            classSelect.innerHTML += `<option value="${cls}">${displayClass}</option>`;
          });
          if (classes.size === 0) {
            showMessage("resultsMessage", "No classes found in the database.", true);
          }
        })
        .catch(error => {
          showMessage("resultsMessage", `Failed to load classes: ${error.message}`, true);
        });
    }

    function getGradeDetails(mark) {
      const grade = gradingTable.find(g => mark >= g.range[0] && mark <= g.range[1]) || gradingTable[gradingTable.length - 1];
      return { rubric: grade.rubric, outcome: grade.outcome };
    }

    function abbreviateSubject(subject) {
      const subjectMap = {
        "Mathematics Activities": "Math",
        "Agriculture": "Agric",
        "English Activities": "Eng",
        "Kiswahili Activities": "Kisw",
        "Integrated Science": "Sci",
        "Social Studies": "Soc",
        "Creative Arts": "Crea",
        "CRE": "Rel",
        "Pre-Technical Studies": "Tech",
        "Language Activities": "Lang",
        "Environmental Activities": "Env",
        "Literacy Activities": "Lit"
      };
      return subjectMap[subject] || subject.slice(0, 4);
    }

    function loadResults() {
      const termSelect = document.getElementById("termSelect").value;
      const assessmentType = document.getElementById("assessmentType").value;
      const className = document.getElementById("classSelect").value;
      const resultsTable = document.getElementById("resultsTable");
      const pdfButton = document.getElementById("pdfButton");
      const reportCardsButton = document.getElementById("reportCardsButton");
      const summaryDiv = document.getElementById("summary");
      const topPerformersDiv = document.getElementById("topPerformers");
      const subjectPerformanceDiv = document.getElementById("subjectPerformance");
      const subjectPerformanceTable = document.getElementById("subjectPerformanceTable");
      const teacherName = document.getElementById("teacherName").textContent;

      if (!termSelect || !assessmentType || !className) {
        showMessage("resultsMessage", "Please select term, assessment type, and class.", true);
        resultsTable.innerHTML = "";
        summaryDiv.innerHTML = "";
        topPerformersDiv.style.display = "none";
        subjectPerformanceDiv.style.display = "none";
        pdfButton.disabled = true;
        reportCardsButton.disabled = true;
        return;
      }

      const displayClass = className.replace(/^(playgroup|preprimary|grade)/, match => ({
        playgroup: "Playgroup",
        preprimary: "Pre-Primary ",
        grade: "Grade "
      }[match])).replace(/(\d)$/, " $1");
      const assessmentLabel = assessmentType === "cat" ? "CAT (Mid-Term)" : "End-Term Exam";

      document.getElementById("loadingScreen").classList.remove("hidden");
      resultsTable.innerHTML = "";
      summaryDiv.innerHTML = "";
      topPerformersDiv.style.display = "none";
      subjectPerformanceDiv.style.display = "none";
      pdfButton.disabled = true;
      reportCardsButton.disabled = true;

      db.ref("users/students").once("value")
        .then(snapshot => {
          const students = snapshot.val() || {};
          const results = [];
          const subjects = new Set();
          const subjectTotals = {};
          const subjectCounts = {};

          Object.entries(students).forEach(([regNo, student]) => {
            if (student.form === className && student.academics && student.academics[termSelect] && student.academics[termSelect][assessmentType]) {
              const marks = student.academics[termSelect][assessmentType];
              const totalMarks = Object.values(marks).reduce((sum, mark) => sum + (Number(mark) || 0), 0);
              Object.keys(marks).forEach(subject => {
                subjects.add(subject);
                subjectTotals[subject] = (subjectTotals[subject] || 0) + (Number(marks[subject]) || 0);
                subjectCounts[subject] = (subjectCounts[subject] || 0) + (marks[subject] !== '' ? 1 : 0);
              });
              results.push({
                name: student.profile.name,
                regNo,
                totalMarks,
                marks
              });
            }
          });

          if (results.length === 0) {
            showMessage("resultsMessage", `No results found for ${displayClass} in ${assessmentLabel} for ${termSelect.replace('term', 'Term ')}.`, true);
            resultsTable.innerHTML = "";
            summaryDiv.innerHTML = "";
            topPerformersDiv.style.display = "none";
            subjectPerformanceDiv.style.display = "none";
            document.getElementById("loadingScreen").classList.add("hidden");
            return;
          }

          results.sort((a, b) => b.totalMarks - a.totalMarks);
          const sortedSubjects = Array.from(subjects).sort();

          let tableHTML = `
            <table>
              <thead>
                <tr>
                  <th>Position</th>
                  <th>Name</th>
                  <th>Reg No</th>
                  <th>Total</th>
                  ${sortedSubjects.map(subject => `
                    <th>${abbreviateSubject(subject)}</th>
                    <th>Rub</th>
                    <th>Out</th>
                  `).join('')}
                </tr>
              </thead>
              <tbody>
          `;

          let totalClassMarks = 0;
          results.forEach((student, index) => {
            totalClassMarks += student.totalMarks;
            tableHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${student.name}</td>
                <td>${student.regNo}</td>
                <td>${student.totalMarks.toFixed(1)}</td>
                ${sortedSubjects.map(subject => {
                  const mark = student.marks[subject] || 0;
                  const grade = getGradeDetails(mark);
                  return `
                    <td>${mark}</td>
                    <td>${grade.rubric}</td>
                    <td>${grade.outcome.toFixed(1)}</td>
                  `;
                }).join('')}
              </tr>
            `;
          });

          const subjectSummary = sortedSubjects.map(subject => {
            const total = subjectTotals[subject] || 0;
            const count = subjectCounts[subject] || 1;
            const mean = (total / count).toFixed(1);
            return { subject, total, mean: parseFloat(mean) };
          }).sort((a, b) => b.mean - a.mean);

          tableHTML += `
              <tr>
                <td colspan="3">Class Total</td>
                <td>${totalClassMarks.toFixed(1)}</td>
                ${sortedSubjects.map(subject => {
                  const total = subjectTotals[subject] || 0;
                  return `<td>${total.toFixed(1)}</td><td></td><td></td>`;
                }).join('')}
              </tr>
              <tr>
                <td colspan="3">Class Mean</td>
                <td>${(totalClassMarks / results.length).toFixed(1)}</td>
                ${sortedSubjects.map(subject => {
                  const total = subjectTotals[subject] || 0;
                  const count = subjectCounts[subject] || 1;
                  const mean = (total / count).toFixed(1);
                  return `<td>${mean}</td><td></td><td></td>`;
                }).join('')}
              </tr>
            </tbody>
          </table>
          `;

          const mean = totalClassMarks / results.length;
          const average = mean.toFixed(1);
          summaryDiv.innerHTML = `<i class="fas fa-chart-bar"></i>Class Mean: ${average} | Class Average: ${average} | Total Students: ${results.length}`;

          let topHTML = '';
          const topCount = Math.min(3, results.length);
          for (let i = 0; i < topCount; i++) {
            topHTML += `<li><i class="fas fa-trophy"></i>${results[i].name} - ${results[i].totalMarks.toFixed(1)}</li>`;
          }
          topPerformersDiv.querySelector('ul').innerHTML = topHTML;
          topPerformersDiv.style.display = "block";

          let subjectPerformanceHTML = `
            <thead>
              <tr>
                <th>Rank</th>
                <th>Subject</th>
                <th>Total Marks</th>
                <th>Mean Score</th>
              </tr>
            </thead>
            <tbody>
          `;
          subjectSummary.forEach((sub, index) => {
            subjectPerformanceHTML += `
              <tr>
                <td>${index + 1}</td>
                <td>${sub.subject}</td>
                <td>${sub.total.toFixed(1)}</td>
                <td>${sub.mean.toFixed(1)}</td>
              </tr>
            `;
          });
          subjectPerformanceHTML += `</tbody>`;
          subjectPerformanceTable.innerHTML = subjectPerformanceHTML;
          subjectPerformanceDiv.style.display = "block";

          resultsTable.innerHTML = tableHTML;
          pdfButton.disabled = false;
          reportCardsButton.disabled = false;
          showMessage("resultsMessage", `Dear ${teacherName}, we found the results for ${displayClass} in ${assessmentLabel} for ${termSelect.replace('term', 'Term ')}.`, false);
          document.getElementById("loadingScreen").classList.add("hidden");

          window.currentResults = { results, sortedSubjects, className, assessmentType, termSelect, mean, average, subjectSummary };
        })
        .catch(error => {
          console.error("Load results error:", error);
          showMessage("resultsMessage", `Failed to load results: ${error.message}`, true);
          document.getElementById("loadingScreen").classList.add("hidden");
        });
    }

    function generatePDF() {
      if (!window.currentResults) {
        showMessage("resultsMessage", "No results to generate PDF.", true);
        return;
      }

      const { results, sortedSubjects, className, assessmentType, termSelect, mean, average, subjectSummary } = window.currentResults;
      const assessmentLabel = assessmentType === "cat" ? "CAT (Mid-Term)" : "End-Term Exam";
      const displayClass = className.replace(/^(playgroup|preprimary|grade)/, match => ({
        playgroup: "Playgroup",
        preprimary: "Pre-Primary ",
        grade: "Grade "
      }[match])).replace(/(\d)$/, " $1");

      const headers = ["Position", "Name", "Reg No", "Total"];
      const subHeaders = sortedSubjects.reduce((acc, subject) => {
        const abbrSubject = abbreviateSubject(subject);
        return [...acc, abbrSubject, "Rub", "Out"];
      }, []);

      const fullHeaders = [...headers, ...subHeaders];

      const data = results.map((student, index) => {
        const row = [
          index + 1,
          student.name,
          student.regNo,
          student.totalMarks.toFixed(1)
        ];
        sortedSubjects.forEach(subject => {
          const mark = student.marks[subject] || 0;
          const grade = getGradeDetails(mark);
          row.push(mark, grade.rubric, grade.outcome.toFixed(1));
        });
        return row;
      });

      const totalRow = ["", "Class Total", "", results.reduce((sum, s) => sum + s.totalMarks, 0).toFixed(1)];
      sortedSubjects.forEach(subject => {
        const total = results.reduce((sum, s) => sum + (Number(s.marks[subject]) || 0), 0);
        totalRow.push(total.toFixed(1), "", "");
      });

      const meanRow = ["", "Class Mean", "", (results.reduce((sum, s) => sum + s.totalMarks, 0) / results.length).toFixed(1)];
      sortedSubjects.forEach(subject => {
        const total = results.reduce((sum, s) => sum + (Number(s.marks[subject]) || 0), 0);
        const count = results.filter(s => s.marks[subject] !== '').length || 1;
        const mean = (total / count).toFixed(1);
        meanRow.push(mean, "", "");
      });

      data.push(totalRow, meanRow);

      const gradingHeaders = ["Score Range", "Rubric", "Outcome"];
      const gradingData = gradingTable.map(g => [
        `${g.range[0]}–${g.range[1]}`,
        g.rubric,
        g.outcome.toFixed(1)
      ]);

      const subjectHeaders = ["Rank", "Subject", "Total Marks", "Mean Score"];
      const subjectData = subjectSummary.map((sub, index) => [
        index + 1,
        sub.subject,
        sub.total.toFixed(1),
        sub.mean.toFixed(1)
      ]);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });

      // Enhanced Header Template
      doc.setFillColor(79, 70, 229); // Purple color
      doc.rect(0, 0, 297, 25, 'F'); // Full width header background
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.setFont("helvetica", "bold");
      doc.text("MACS SCHOOLS EA", 148.5, 12, { align: 'center' });
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("Excellence in Education | P.O. Box 123, Nairobi, Kenya | Tel: +254 700 123 456 | Email: info@macsschools.co.ke", 148.5, 18, { align: 'center' });

      // Subheader
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.text("CLASS RESULTS REPORT", 14, 35);
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text(`Class: ${displayClass} | Term: ${termSelect.replace('term', 'Term ')} | Assessment: ${assessmentLabel}`, 14, 42);
      doc.text(`Generated on: ${new Date().toLocaleString('en-US', { timeZone: 'Africa/Nairobi' })}`, 14, 48);

      // Decorative line
      doc.setDrawColor(244, 63, 94); // Pink color
      doc.setLineWidth(1);
      doc.line(14, 52, 283, 52);

      doc.autoTable({
        startY: 55,
        head: [fullHeaders],
        body: data,
        theme: 'grid',
        styles: { 
          fontSize: 7, 
          cellPadding: 2, 
          overflow: 'linebreak', 
          font: 'helvetica',
          lineColor: [200, 200, 200],
          lineWidth: 0.5,
          fillColor: [249, 250, 251] // Light gray for body
        },
        headStyles: { 
          fillColor: [79, 70, 229], 
          textColor: [255, 255, 255], 
          fontStyle: 'bold',
          lineColor: [79, 70, 229],
          lineWidth: 1
        },
        alternateRowStyles: { fillColor: [240, 231, 254] }, // Light purple alternate
        columnStyles: {
          0: { cellWidth: 10 },
          1: { cellWidth: 25 },
          2: { cellWidth: 15 },
          3: { cellWidth: 10 },
          ...sortedSubjects.reduce((acc, _, i) => ({
            ...acc,
            [4 + i * 3]: { cellWidth: 8 },
            [5 + i * 3]: { cellWidth: 8 },
            [6 + i * 3]: { cellWidth: 8 }
          }), {})
        },
        margin: { left: 14, right: 14 }
      });

      const finalY = doc.lastAutoTable.finalY || 55;
      doc.setFontSize(9);
      doc.setTextColor(0, 0, 0);
      doc.setFont("helvetica", "bold");
      doc.text("SUMMARY", 14, finalY + 10);
      doc.setFont("helvetica", "normal");
      doc.text(`Class Mean: ${average} | Class Average: ${average} | Total Students: ${results.length}`, 14, finalY + 18);

      // Signatures Section
      doc.setFontSize(8);
      const sigY = finalY + 30;
      doc.setDrawColor(244, 63, 94);
      doc.line(14, sigY, 283, sigY);
      doc.setTextColor(0, 0, 0);
      doc.text("Approved by:", 14, sigY + 5);
      doc.text("___________________________", 14, sigY + 10);
      doc.text("Mad Annah Moraa", 14, sigY + 15);
      doc.text("Director of Studies", 14, sigY + 20);
      doc.text("___________________________", 200, sigY + 10);
      doc.text("Jared Moinani", 200, sigY + 15);
      doc.text("Head Teacher", 200, sigY + 20);

      doc.addPage();
      // Grading Table Page
      doc.setFillColor(79, 70, 229);
      doc.rect(0, 0, 297, 25, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.setFont("helvetica", "bold");
      doc.text("GRADING SCALE & PERFORMANCE SUMMARY", 148.5, 12, { align: 'center' });
      doc.setFontSize(10);
      doc.setFont("helvetica", "normal");
      doc.text("MACS SCHOOLS EA | Excellence in Education", 148.5, 18, { align: 'center' });

      doc.setTextColor(0, 0, 0);
      doc.setDrawColor(244, 63, 94);
      doc.setLineWidth(1);
      doc.line(14, 30, 283, 30);

      doc.autoTable({
        startY: 35,
        head: [gradingHeaders],
        body: gradingData,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 4, font: 'helvetica', lineColor: [200, 200, 200], lineWidth: 0.5 },
        headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255], fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [240, 231, 254] },
        columnStyles: { 0: { cellWidth: 50 }, 1: { cellWidth: 50 }, 2: { cellWidth: 50 } },
        margin: { left: 14, right: 14 }
      });

      const gradingFinalY = doc.lastAutoTable.finalY || 35;
      doc.setFontSize(14);
      doc.setFont("helvetica", "bold");
      doc.text("SUBJECT PERFORMANCE SUMMARY", 14, gradingFinalY + 15);
      doc.setFont("helvetica", "normal");

      doc.autoTable({
        startY: gradingFinalY + 25,
        head: [subjectHeaders],
        body: subjectData,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 4, font: 'helvetica', lineColor: [200, 200, 200], lineWidth: 0.5 },
        headStyles: { fillColor: [244, 63, 94], textColor: [255, 255, 255], fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [251, 240, 247] }, // Light pink alternate
        columnStyles: { 0: { cellWidth: 20 }, 1: { cellWidth: 80 }, 2: { cellWidth: 50 }, 3: { cellWidth: 50 } },
        margin: { left: 14, right: 14 }
      });

      // Footer for all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Page ${i} of ${pageCount} | Confidential - For Official Use Only`, 148.5, 290, { align: 'center' });
      }

      document.getElementById("loadingScreen").classList.remove("hidden");
      try {
        doc.save(`MACS_Schools_${className}_${termSelect}_${assessmentType}_Results_${new Date().toISOString().split("T")[0]}.pdf`);
        showMessage("resultsMessage", "PDF file generated successfully!", false);
      } catch (error) {
        console.error("PDF generation error:", error);
        showMessage("resultsMessage", `Failed to generate PDF: ${error.message}`, true);
      } finally {
        document.getElementById("loadingScreen").classList.add("hidden");
      }
    }

    function generateReportCardsPDF() {
      if (!window.currentResults) {
        showMessage("resultsMessage", "No results to generate report cards.", true);
        return;
      }

      const { results, sortedSubjects, className, assessmentType, termSelect } = window.currentResults;
      const assessmentLabel = assessmentType === "cat" ? "CAT (Mid-Term)" : "End-Term Exam";
      const displayClass = className.replace(/^(playgroup|preprimary|grade)/, match => ({
        playgroup: "Playgroup",
        preprimary: "Pre-Primary ",
        grade: "Grade "
      }[match])).replace(/(\d)$/, " $1");
      const numSubjects = sortedSubjects.length;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');

      document.getElementById("loadingScreen").classList.remove("hidden");

      try {
        results.forEach((student, index) => {
          if (index > 0) {
            doc.addPage();
          }

          // Enhanced Report Card Header Template
          doc.setFillColor(79, 70, 229); // Purple header
          doc.rect(0, 0, 210, 30, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(18);
          doc.setFont("helvetica", "bold");
          doc.text("MACS SCHOOLS EA", 105, 15, { align: 'center' });
          doc.setFontSize(10);
          doc.setFont("helvetica", "normal");
          doc.text("Excellence in Education | P.O. Box 123, Nairobi, Kenya", 105, 22, { align: 'center' });

          // Decorative line
          doc.setDrawColor(244, 63, 94); // Pink line
          doc.setLineWidth(1.5);
          doc.line(10, 32, 200, 32);

          // Student Details - Balanced spacing
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(12);
          doc.setFont("helvetica", "bold");
          doc.text("STUDENT REPORT CARD", 105, 40, { align: 'center' });
          doc.setFontSize(9);
          doc.setFont("helvetica", "normal");
          doc.text(`Student Name: ${student.name}`, 20, 50);
          doc.text(`Registration No: ${student.regNo}`, 20, 57);
          doc.text(`Class: ${displayClass}`, 20, 64);
          doc.text(`Term: ${termSelect.replace('term', 'Term ')}`, 20, 71);
          doc.text(`Assessment: ${assessmentLabel}`, 20, 78);
          doc.text(`Date: ${new Date().toLocaleString('en-US', { timeZone: 'Africa/Nairobi' })}`, 20, 85);

          // Marks Table - Adjusted startY for balance
          const reportHeaders = ["Subject", "Mark (%)", "Rubric", "Outcome"];
          const reportData = sortedSubjects.map(subject => {
            const mark = student.marks[subject] || 0;
            const grade = getGradeDetails(mark);
            return [subject, mark.toString(), grade.rubric, grade.outcome.toFixed(1)];
          });

          doc.autoTable({
            startY: 92,
            head: [reportHeaders],
            body: reportData,
            theme: 'grid',
            styles: { 
              fontSize: 8, 
              cellPadding: 3, 
              overflow: 'linebreak', 
              font: 'helvetica',
              lineColor: [200, 200, 200],
              lineWidth: 0.5,
              fillColor: [255, 255, 255]
            },
            headStyles: { 
              fillColor: [244, 63, 94], 
              textColor: [255, 255, 255], 
              fontStyle: 'bold',
              lineColor: [244, 63, 94],
              lineWidth: 1
            },
            alternateRowStyles: { fillColor: [251, 240, 247] }, // Light pink
            columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 20 }, 2: { cellWidth: 30 }, 3: { cellWidth: 20 } },
            margin: { left: 20, right: 20 }
          });

          const tableFinalY = doc.lastAutoTable.finalY || 92;

          // Performance Summary - On white surface, no blue background, balanced spacing
          const total = student.totalMarks.toFixed(1);
          const mean = (student.totalMarks / numSubjects).toFixed(1);
          const position = index + 1;
          const comment = getComment(parseFloat(mean));

          // Draw a light border for the summary box on white
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.5);
          doc.rect(20, tableFinalY + 10, 170, 40);

          doc.setTextColor(0, 0, 0);
          doc.setFontSize(10);
          doc.setFont("helvetica", "bold");
          doc.text("PERFORMANCE SUMMARY", 30, tableFinalY + 20);
          doc.setFont("helvetica", "normal");
          doc.setFontSize(9);
          doc.text(`Total Marks: ${total}`, 30, tableFinalY + 28);
          doc.text(`Mean Score: ${mean}%`, 30, tableFinalY + 35);
          doc.text(`Position: ${position} out of ${results.length}`, 30, tableFinalY + 42);
          doc.text(`Teacher's Comment:`, 30, tableFinalY + 49);
          doc.text(comment, 30, tableFinalY + 56, { maxWidth: 150 });

          // Signatures - Adjusted for better balance and spacing
          const sigY = tableFinalY + 65;
          doc.setDrawColor(244, 63, 94);
          doc.setLineWidth(1);
          doc.line(20, sigY, 90, sigY);
          doc.line(120, sigY, 190, sigY);
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(8);
          doc.setFont("helvetica", "normal");
          doc.text("Class Teacher's Signature:", 25, sigY + 8);
          doc.text("___________________________", 25, sigY + 15);
          doc.text("Parent/Guardian's Signature:", 125, sigY + 8);
          doc.text("___________________________", 125, sigY + 15);

          // Additional approvals below with more space
          const approvalY = sigY + 35;
          doc.setDrawColor(244, 63, 94);
          doc.line(20, approvalY, 90, approvalY);
          doc.line(120, approvalY, 190, approvalY);
          doc.text("Director of Studies:", 25, approvalY + 8);
          doc.text("Mad Annah Moraa", 25, approvalY + 15);
          doc.text("___________________________", 25, approvalY + 22);
          doc.text("Head Teacher:", 125, approvalY + 8);
          doc.text("Jared Moinani", 125, approvalY + 15);
          doc.text("___________________________", 125, approvalY + 22);

          // Footer - Ensure it doesn't overlap
          const footerY = Math.max(270, approvalY + 40);
          doc.setTextColor(128, 128, 128);
          doc.setFontSize(7);
          doc.text("Confidential - MACS Schools EA | For Official Student Records Only", 105, footerY, { align: 'center' });
        });

        doc.save(`MACS_ReportCards_${className}_${termSelect}_${assessmentType}_${new Date().toISOString().split("T")[0]}.pdf`);
        showMessage("resultsMessage", "Report Cards PDF generated successfully!", false);
      } catch (error) {
        console.error("Report Cards PDF generation error:", error);
        showMessage("resultsMessage", `Failed to generate Report Cards PDF: ${error.message}`, true);
      } finally {
        document.getElementById("loadingScreen").classList.add("hidden");
      }
    }

    function logout() {
      auth.signOut().then(() => {
        localStorage.clear();
        window.location.href = "index.html";
      }).catch(error => {
        showMessage("resultsMessage", `Logout failed: ${error.message}`, true);
      });
    }
  </script>
</body>
</html>